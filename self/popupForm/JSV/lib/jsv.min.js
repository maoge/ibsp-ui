var exports=exports||this,require=require||function(){return exports};(function(){var i=require("./uri/uri").URI,e={},A="0123456789abcdef".split(""),k,o,z,g;function d(B){return B===undefined?"undefined":(B===null?"null":Object.prototype.toString.call(B).split(" ").pop().split("]").shift().toLowerCase())}function l(){}function t(B){l.prototype=B||{};return new l()}function b(F,E,D){var B={},C;for(C in F){if(F[C]!==e[C]){B[C]=E.call(D,F[C],C,F)}}return B}k=function(C,F,E){var B=0,G=C.length,D=new Array(G);for(;B<G;++B){D[B]=F.call(E,C[B],B,C)}return D};if(Array.prototype.map){k=function(B,D,C){return Array.prototype.map.call(B,D,C)}}o=function(C,F,E){var B=0,G=C.length,D=[];for(;B<G;++B){if(F.call(E,C[B],B,C)){D[D.length]=C[B]}}return D};if(Array.prototype.filter){o=function(B,D,C){return Array.prototype.filter.call(B,D,C)}}z=function(C,D){var B=0,E=C.length;for(;B<E;++B){if(C[B]===D){return B}}return -1};if(Array.prototype.indexOf){z=function(B,C){return Array.prototype.indexOf.call(B,C)}}function v(B){return B!==undefined&&B!==null?(B instanceof Array&&!B.callee?B:(typeof B.length!=="number"||B.split||B.setInterval||B.call?[B]:Array.prototype.slice.call(B))):[]}function n(D){var B=[],C;switch(d(D)){case"object":for(C in D){if(D[C]!==e[C]){B[B.length]=C}}break;case"array":for(C=D.length-1;C>=0;--C){B[C]=C}break}return B}function f(B,C){if(z(B,C)===-1){B.push(C)}return B}function p(B,D){var C=z(B,D);if(C>-1){B.splice(C,1)}return B}function u(){return[A[Math.floor(Math.random()*16)],A[Math.floor(Math.random()*16)],A[Math.floor(Math.random()*16)],A[Math.floor(Math.random()*16)],A[Math.floor(Math.random()*16)],A[Math.floor(Math.random()*16)],A[Math.floor(Math.random()*16)],A[Math.floor(Math.random()*16)],"-",A[Math.floor(Math.random()*16)],A[Math.floor(Math.random()*16)],A[Math.floor(Math.random()*16)],A[Math.floor(Math.random()*16)],"-4",A[Math.floor(Math.random()*16)],A[Math.floor(Math.random()*16)],A[Math.floor(Math.random()*16)],"-",A[(Math.floor(Math.random()*16)&3)|8],A[Math.floor(Math.random()*16)],A[Math.floor(Math.random()*16)],A[Math.floor(Math.random()*16)],"-",A[Math.floor(Math.random()*16)],A[Math.floor(Math.random()*16)],A[Math.floor(Math.random()*16)],A[Math.floor(Math.random()*16)],A[Math.floor(Math.random()*16)],A[Math.floor(Math.random()*16)],A[Math.floor(Math.random()*16)],A[Math.floor(Math.random()*16)],A[Math.floor(Math.random()*16)],A[Math.floor(Math.random()*16)],A[Math.floor(Math.random()*16)],A[Math.floor(Math.random()*16)]].join("")}function x(B){return encodeURIComponent(B).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A")}function a(B){if(typeof B==="string"&&B.indexOf("#")===-1){B+="#"}return B}function s(B){if(B instanceof w){return B.getURI()}switch(d(B)){case"undefined":case"null":case"boolean":case"number":case"string":return B;case"object":return b(B,s);case"array":return k(B,s);default:return B.toString()}}function c(C,F,B,E,D){Error.call(this,E);this.uri=C instanceof w?C.getURI():C;this.schemaUri=F instanceof w?F.getURI():F;this.attribute=B;this.message=E;this.description=E;this.details=D}c.prototype=new Error();c.prototype.constructor=c;c.prototype.name="InitializationError";function q(){this.errors=[];this.validated={}}q.prototype.addError=function(C,F,B,E,D){this.errors.push({uri:C instanceof w?C.getURI():C,schemaUri:F instanceof w?F.getURI():F,attribute:B,message:E,details:s(D)})};q.prototype.registerValidation=function(C,B){if(!this.validated[C]){this.validated[C]=[B]}else{this.validated[C].push(B)}};q.prototype.isValidatedBy=function(C,B){return !!this.validated[C]&&z(this.validated[C],B)!==-1};function w(D,C,E,B){if(C instanceof w){if(typeof B!=="string"){B=C._fd}if(typeof E!=="string"){E=C._uri}C=C._value}if(typeof E!=="string"){E="urn:uuid:"+u()+"#"}else{if(E.indexOf(":")===-1){E=a(i.resolve("urn:uuid:"+u()+"#",E))}}this._env=D;this._value=C;this._uri=E;this._fd=B||this._env._options.defaultFragmentDelimiter}w.prototype.getEnvironment=function(){return this._env};w.prototype.getType=function(){return d(this._value)};w.prototype.getValue=function(){return this._value};w.prototype.getURI=function(){return this._uri};w.prototype.resolveURI=function(B){return a(i.resolve(this._uri,B))};w.prototype.getPropertyNames=function(){return n(this._value)};w.prototype.getProperty=function(B){var C=this._value?this._value[B]:undefined;if(C instanceof w){return C}return new w(this._env,C,this._uri+this._fd+x(B),this._fd)};w.prototype.getProperties=function(){var C=d(this._value),B=this;if(C==="object"){return b(this._value,function(E,D){if(E instanceof w){return E}return new w(B._env,E,B._uri+B._fd+x(D),B._fd)})}else{if(C==="array"){return k(this._value,function(E,D){if(E instanceof w){return E}return new w(B._env,E,B._uri+B._fd+x(D),B._fd)})}}};w.prototype.getValueOfProperty=function(B){if(this._value){if(this._value[B] instanceof w){return this._value[B]._value}return this._value[B]}};w.prototype.equals=function(B){if(B instanceof w){return this._value===B._value}return this._value===B};function y(E,C){var D,B;if(E instanceof w){E=E.getValue()}switch(d(E)){case"object":if(C){D={};for(B in E){if(E[B]!==e[B]){D[B]=y(E[B],C)}}return D}else{return t(E)}break;case"array":if(C){D=new Array(E.length);B=E.length;while(--B>=0){D[B]=y(E[B],C)}return D}else{return Array.prototype.slice.call(E)}break;default:return E}}function r(D,C,F,E){var B;w.call(this,D,C,F);if(E===true){this._schema=this}else{if(C instanceof r&&!(E instanceof r)){this._schema=C._schema}else{this._schema=E instanceof r?E:this._env.getDefaultSchema()||this._env.createEmptySchema()}}B=this._schema.getValueOfProperty("fragmentResolution");if(B==="dot-delimited"){this._fd="."}else{if(B==="slash-delimited"){this._fd="/"}}return this.rebuild()}r.prototype=t(w.prototype);r.prototype.getSchema=function(){var B=this._refs&&this._refs.describedby,C;if(B){C=B&&this._env.findSchema(B);if(C){if(!C.equals(this._schema)){this._schema=C;this.rebuild()}}else{if(this._env._options.enforceReferences){throw new c(this,this._schema,"{describedby}","Unknown schema reference",B)}}}return this._schema};r.prototype.getAttribute=function(E,D){var C,H,G,B,F=this.getSchema();if(!D&&this._attributes&&this._attributes.hasOwnProperty(E)){return this._attributes[E]}C=F.getProperty("properties").getProperty(E);H=C.getValueOfProperty("parser");G=this.getProperty(E);if(typeof H==="function"){B=H(G,C,D);if(!D&&this._attributes){this._attributes[E]=B}return B}return G.getValue()};r.prototype.getAttributes=function(){var D,F,C,B,G,E=this.getSchema();if(!this._attributes&&this.getType()==="object"){D=this.getProperties();F=E.getProperty("properties");this._attributes={};for(C in D){if(D[C]!==e[C]){B=F&&F.getProperty(C);G=B&&B.getValueOfProperty("parser");if(typeof G==="function"){this._attributes[C]=G(D[C],B)}else{this._attributes[C]=D[C].getValue()}}}}return y(this._attributes,false)};r.prototype.getLink=function(C,B){var D=this.getAttribute("links",[C,B]);if(D&&D.length&&D[D.length-1]){return D[D.length-1]}};r.prototype.validate=function(B,D,G,H,E){var C=this.getSchema(),F=C.getValueOfProperty("validator");if(!(B instanceof w)){B=this.getEnvironment().createInstance(B)}if(!(D instanceof q)){D=new q()}if(this._env._options.validateReferences&&this._refs){if(this._refs.describedby&&!this._env.findSchema(this._refs.describedby)){D.addError(this,this._schema,"{describedby}","Unknown schema reference",this._refs.describedby)}if(this._refs.full&&!this._env.findSchema(this._refs.full)){D.addError(this,this._schema,"{full}","Unknown schema reference",this._refs.full)}}if(typeof F==="function"&&!D.isValidatedBy(B.getURI(),this.getURI())){D.registerValidation(B.getURI(),this.getURI());F(B,this,C,D,G,H,E)}return D};function h(C){return function B(){var E=this,D=[],G=E._refs&&E._refs.full,F;while(G){F=E._env.findSchema(G);if(F){if(F._value===E._value){break}E=F;D.push(G);G=E._refs&&E._refs.full;if(D.indexOf(G)>-1){break}}else{if(E._env._options.enforceReferences){throw new c(E,E._schema,"{full}","Unknown schema reference",G)}else{G=null}}}return C.apply(E,arguments)}}(function(){var B;for(B in r.prototype){if(r.prototype[B]!==e[B]&&d(r.prototype[B])==="function"){r.prototype[B]=h(r.prototype[B])}}}());r.prototype.rebuild=function(){var B=this,C=B.getSchema().getValueOfProperty("initializer");B._refs=null;B._attributes=null;if(typeof C==="function"){B=C(B)}B._env._schemas[B._uri]=B;B.getAttributes();return B};r.prototype.setReference=function(B,C){if(!this._refs){this._refs={}}this._refs[B]=this.resolveURI(C)};r.prototype.getReference=function(B){return this._refs&&this._refs[B]};function j(F,C,H){var E=d(F),D=d(C),G,B;if(D==="undefined"){return y(F,true)}else{if(E==="undefined"||D!==E){return y(C,true)}else{if(D==="object"){if(F instanceof r){F=F.getAttributes()}if(C instanceof r){C=C.getAttributes();if(C["extends"]&&H&&C["extends"] instanceof r){C["extends"]=[C["extends"]]}}G=y(F,true);for(B in C){if(C[B]!==e[B]){G[B]=j(F[B],C[B],H)}}return G}else{return y(C,true)}}}}function m(){this._id=u();this._schemas={};this._options={};this.createSchema({},true,"urn:jsv:empty-schema#")}m.prototype.clone=function(){var B=new m();B._schemas=t(this._schemas);B._options=t(this._options);return B};m.prototype.createInstance=function(C,B){B=a(B);if(C instanceof w&&(!B||C.getURI()===B)){return C}return new w(this,C,B)};m.prototype.createSchema=function(D,C,B){B=a(B);if(D instanceof r&&(!B||D._uri===B)&&(!C||D.getSchema().equals(C))){return D}return new r(this,D,B,C)};m.prototype.createEmptySchema=function(){return this._schemas["urn:jsv:empty-schema#"]};m.prototype.findSchema=function(B){return this._schemas[a(B)]};m.prototype.setOption=function(B,C){this._options[B]=C};m.prototype.getOption=function(B){return this._options[B]};m.prototype.setDefaultFragmentDelimiter=function(B){if(typeof B==="string"&&B.length>0){this._options.defaultFragmentDelimiter=B}};m.prototype.getDefaultFragmentDelimiter=function(){return this._options.defaultFragmentDelimiter};m.prototype.setDefaultSchemaURI=function(B){if(typeof B==="string"){this._options.defaultSchemaURI=a(B)}};m.prototype.getDefaultSchema=function(){return this.findSchema(this._options.defaultSchemaURI)};m.prototype.validate=function(I,H){var B,E,D,C=new q();try{B=this.createInstance(I);C.instance=B}catch(G){C.addError(G.uri,G.schemaUri,G.attribute,G.message,G.details)}try{E=this.createSchema(H);C.schema=E;D=E.getSchema();C.schemaSchema=D}catch(F){C.addError(F.uri,F.schemaUri,F.attribute,F.message,F.details)}if(D){D.validate(E,C)}if(C.errors.length){return C}return E.validate(B,C)};m.prototype._checkForInvalidInstances=function(H,D){var K=[],F=[[D,this._schemas[D]]],B=0,J,C,I,E,G;while(B++<H&&F.length){J=F.shift();C=J[0];I=J[1];if(I instanceof r){if(this._schemas[I._uri]!==I){K.push("Instance "+C+" does not match "+I._uri)}else{E=I.getAttributes();for(G in E){if(E[G]!==e[G]){F.push([C+"/"+x(G),E[G]])}}}}else{if(d(I)==="object"){E=I;for(G in E){if(E.hasOwnProperty(G)){F.push([C+"/"+x(G),E[G]])}}}else{if(d(I)==="array"){E=I;for(G=0;G<E.length;++G){F.push([C+"/"+x(G),E[G]])}}}}}return K.length?K:B};g={_environments:{},_defaultEnvironmentID:"",isJSONInstance:function(B){return B instanceof w},isJSONSchema:function(B){return B instanceof r},createEnvironment:function(B){B=B||this._defaultEnvironmentID;if(!this._environments[B]){throw new Error("Unknown Environment ID")}return this._environments[B].clone()},Environment:m,registerEnvironment:function(C,B){C=C||(B||0)._id;if(C&&!this._environments[C]&&B instanceof m){B._id=C;this._environments[C]=B}},setDefaultEnvironmentID:function(B){if(typeof B==="string"){if(!this._environments[B]){throw new Error("Unknown Environment ID")}this._defaultEnvironmentID=B}},getDefaultEnvironmentID:function(){return this._defaultEnvironmentID},typeOf:d,createObject:t,mapObject:b,mapArray:k,filterArray:o,searchArray:z,toArray:v,keys:n,pushUnique:f,popFirst:p,clone:y,randomUUID:u,escapeURIComponent:x,formatURI:a,inherits:j,InitializationError:c};this.JSV=g;exports.JSV=g;require("./environments")}());