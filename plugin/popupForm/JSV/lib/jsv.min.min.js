var exports=exports||this,require=require||function(){return exports};(function(){var T=require("./uri/uri").URI,X={},L="0123456789abcdef".split(""),R,N,B,V;function Y(a){return a===undefined?"undefined":(a===null?"null":Object.prototype.toString.call(a).split(" ").pop().split("]").shift().toLowerCase())}function Q(){}function H(a){Q.prototype=a||{};return new Q()}function aa(a,b,c){var e={},d;for(d in a){if(a[d]!==X[d]){e[d]=b.call(c,a[d],d,a)}}return e}R=function(e,b,c){var f=0,a=e.length,d=new Array(a);for(;f<a;++f){d[f]=b.call(c,e[f],f,e)}return d};if(Array.prototype.map){R=function(c,a,b){return Array.prototype.map.call(c,a,b)}}N=function(e,b,c){var f=0,a=e.length,d=[];for(;f<a;++f){if(b.call(c,e[f],f,e)){d[d.length]=e[f]}}return d};if(Array.prototype.filter){N=function(c,a,b){return Array.prototype.filter.call(c,a,b)}}B=function(c,b){var d=0,a=c.length;for(;d<a;++d){if(c[d]===b){return d}}return -1};if(Array.prototype.indexOf){B=function(b,a){return Array.prototype.indexOf.call(b,a)}}function F(a){return a!==undefined&&a!==null?(a instanceof Array&&!a.callee?a:(typeof a.length!=="number"||a.split||a.setInterval||a.call?[a]:Array.prototype.slice.call(a))):[]}function O(a){var c=[],b;switch(Y(a)){case"object":for(b in a){if(a[b]!==X[b]){c[c.length]=b}}break;case"array":for(b=a.length-1;b>=0;--b){c[b]=b}break}return c}function W(b,a){if(B(b,a)===-1){b.push(a)}return b}function M(c,a){var b=B(c,a);if(b>-1){c.splice(b,1)}return c}function G(){return[L[Math.floor(Math.random()*16)],L[Math.floor(Math.random()*16)],L[Math.floor(Math.random()*16)],L[Math.floor(Math.random()*16)],L[Math.floor(Math.random()*16)],L[Math.floor(Math.random()*16)],L[Math.floor(Math.random()*16)],L[Math.floor(Math.random()*16)],"-",L[Math.floor(Math.random()*16)],L[Math.floor(Math.random()*16)],L[Math.floor(Math.random()*16)],L[Math.floor(Math.random()*16)],"-4",L[Math.floor(Math.random()*16)],L[Math.floor(Math.random()*16)],L[Math.floor(Math.random()*16)],"-",L[(Math.floor(Math.random()*16)&3)|8],L[Math.floor(Math.random()*16)],L[Math.floor(Math.random()*16)],L[Math.floor(Math.random()*16)],"-",L[Math.floor(Math.random()*16)],L[Math.floor(Math.random()*16)],L[Math.floor(Math.random()*16)],L[Math.floor(Math.random()*16)],L[Math.floor(Math.random()*16)],L[Math.floor(Math.random()*16)],L[Math.floor(Math.random()*16)],L[Math.floor(Math.random()*16)],L[Math.floor(Math.random()*16)],L[Math.floor(Math.random()*16)],L[Math.floor(Math.random()*16)],L[Math.floor(Math.random()*16)]].join("")}function D(a){return encodeURIComponent(a).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A")}function ab(a){if(typeof a==="string"&&a.indexOf("#")===-1){a+="#"}return a}function I(a){if(a instanceof E){return a.getURI()}switch(Y(a)){case"undefined":case"null":case"boolean":case"number":case"string":return a;case"object":return aa(a,I);case"array":return R(a,I);default:return a.toString()}}function Z(d,a,e,b,c){Error.call(this,b);this.uri=d instanceof E?d.getURI():d;this.schemaUri=a instanceof E?a.getURI():a;this.attribute=e;this.message=b;this.description=b;this.details=c}Z.prototype=new Error();Z.prototype.constructor=Z;Z.prototype.name="InitializationError";function K(){this.errors=[];this.validated={}}K.prototype.addError=function(d,a,e,b,c){this.errors.push({uri:d instanceof E?d.getURI():d,schemaUri:a instanceof E?a.getURI():a,attribute:e,message:b,details:I(c)})};K.prototype.registerValidation=function(a,b){if(!this.validated[a]){this.validated[a]=[b]}else{this.validated[a].push(b)}};K.prototype.isValidatedBy=function(a,b){return !!this.validated[a]&&B(this.validated[a],b)!==-1};function E(b,c,a,d){if(c instanceof E){if(typeof d!=="string"){d=c._fd}if(typeof a!=="string"){a=c._uri}c=c._value}if(typeof a!=="string"){a="urn:uuid:"+G()+"#"}else{if(a.indexOf(":")===-1){a=ab(T.resolve("urn:uuid:"+G()+"#",a))}}this._env=b;this._value=c;this._uri=a;this._fd=d||this._env._options.defaultFragmentDelimiter}E.prototype.getEnvironment=function(){return this._env};E.prototype.getType=function(){return Y(this._value)};E.prototype.getValue=function(){return this._value};E.prototype.getURI=function(){return this._uri};E.prototype.resolveURI=function(a){return ab(T.resolve(this._uri,a))};E.prototype.getPropertyNames=function(){return O(this._value)};E.prototype.getProperty=function(b){var a=this._value?this._value[b]:undefined;if(a instanceof E){return a}return new E(this._env,a,this._uri+this._fd+D(b),this._fd)};E.prototype.getProperties=function(){var a=Y(this._value),b=this;if(a==="object"){return aa(this._value,function(c,d){if(c instanceof E){return c}return new E(b._env,c,b._uri+b._fd+D(d),b._fd)})}else{if(a==="array"){return R(this._value,function(c,d){if(c instanceof E){return c}return new E(b._env,c,b._uri+b._fd+D(d),b._fd)})}}};E.prototype.getValueOfProperty=function(a){if(this._value){if(this._value[a] instanceof E){return this._value[a]._value}return this._value[a]}};E.prototype.equals=function(a){if(a instanceof E){return this._value===a._value}return this._value===a};function C(a,c){var b,d;if(a instanceof E){a=a.getValue()}switch(Y(a)){case"object":if(c){b={};for(d in a){if(a[d]!==X[d]){b[d]=C(a[d],c)}}return b}else{return H(a)}break;case"array":if(c){b=new Array(a.length);d=a.length;while(--d>=0){b[d]=C(a[d],c)}return b}else{return Array.prototype.slice.call(a)}break;default:return a}}function J(c,d,a,b){var e;E.call(this,c,d,a);if(b===true){this._schema=this}else{if(d instanceof J&&!(b instanceof J)){this._schema=d._schema}else{this._schema=b instanceof J?b:this._env.getDefaultSchema()||this._env.createEmptySchema()}}e=this._schema.getValueOfProperty("fragmentResolution");if(e==="dot-delimited"){this._fd="."}else{if(e==="slash-delimited"){this._fd="/"}}return this.rebuild()}J.prototype=H(E.prototype);J.prototype.getSchema=function(){var b=this._refs&&this._refs.describedby,a;if(b){a=b&&this._env.findSchema(b);if(a){if(!a.equals(this._schema)){this._schema=a;this.rebuild()}}else{if(this._env._options.enforceReferences){throw new Z(this,this._schema,"{describedby}","Unknown schema reference",b)}}}return this._schema};J.prototype.getAttribute=function(d,e){var f,a,b,g,c=this.getSchema();if(!e&&this._attributes&&this._attributes.hasOwnProperty(d)){return this._attributes[d]}f=c.getProperty("properties").getProperty(d);a=f.getValueOfProperty("parser");b=this.getProperty(d);if(typeof a==="function"){g=a(b,f,e);if(!e&&this._attributes){this._attributes[d]=g}return g}return b.getValue()};J.prototype.getAttributes=function(){var d,b,e,f,a,c=this.getSchema();if(!this._attributes&&this.getType()==="object"){d=this.getProperties();b=c.getProperty("properties");this._attributes={};for(e in d){if(d[e]!==X[e]){f=b&&b.getProperty(e);a=f&&f.getValueOfProperty("parser");if(typeof a==="function"){this._attributes[e]=a(d[e],f)}else{this._attributes[e]=d[e].getValue()}}}}return C(this._attributes,false)};J.prototype.getLink=function(b,c){var a=this.getAttribute("links",[b,c]);if(a&&a.length&&a[a.length-1]){return a[a.length-1]}};J.prototype.validate=function(g,e,b,a,d){var f=this.getSchema(),c=f.getValueOfProperty("validator");if(!(g instanceof E)){g=this.getEnvironment().createInstance(g)}if(!(e instanceof K)){e=new K()}if(this._env._options.validateReferences&&this._refs){if(this._refs.describedby&&!this._env.findSchema(this._refs.describedby)){e.addError(this,this._schema,"{describedby}","Unknown schema reference",this._refs.describedby)}if(this._refs.full&&!this._env.findSchema(this._refs.full)){e.addError(this,this._schema,"{full}","Unknown schema reference",this._refs.full)}}if(typeof c==="function"&&!e.isValidatedBy(g.getURI(),this.getURI())){e.registerValidation(g.getURI(),this.getURI());c(g,this,f,e,b,a,d)}return e};function U(a){return function b(){var e=this,f=[],c=e._refs&&e._refs.full,d;while(c){d=e._env.findSchema(c);if(d){if(d._value===e._value){break}e=d;f.push(c);c=e._refs&&e._refs.full;if(f.indexOf(c)>-1){break}}else{if(e._env._options.enforceReferences){throw new Z(e,e._schema,"{full}","Unknown schema reference",c)}else{c=null}}}return a.apply(e,arguments)}}(function(){var a;for(a in J.prototype){if(J.prototype[a]!==X[a]&&Y(J.prototype[a])==="function"){J.prototype[a]=U(J.prototype[a])}}}());J.prototype.rebuild=function(){var b=this,a=b.getSchema().getValueOfProperty("initializer");b._refs=null;b._attributes=null;if(typeof a==="function"){b=a(b)}b._env._schemas[b._uri]=b;b.getAttributes();return b};J.prototype.setReference=function(b,a){if(!this._refs){this._refs={}}this._refs[b]=this.resolveURI(a)};J.prototype.getReference=function(a){return this._refs&&this._refs[a]};function S(c,f,a){var d=Y(c),e=Y(f),b,g;if(e==="undefined"){return C(c,true)}else{if(d==="undefined"||e!==d){return C(f,true)}else{if(e==="object"){if(c instanceof J){c=c.getAttributes()}if(f instanceof J){f=f.getAttributes();if(f["extends"]&&a&&f["extends"] instanceof J){f["extends"]=[f["extends"]]}}b=C(c,true);for(g in f){if(f[g]!==X[g]){b[g]=S(c[g],f[g],a)}}return b}else{return C(f,true)}}}}function P(){this._id=G();this._schemas={};this._options={};this.createSchema({},true,"urn:jsv:empty-schema#")}P.prototype.clone=function(){var a=new P();a._schemas=H(this._schemas);a._options=H(this._options);return a};P.prototype.createInstance=function(a,b){b=ab(b);if(a instanceof E&&(!b||a.getURI()===b)){return a}return new E(this,a,b)};P.prototype.createSchema=function(a,b,c){c=ab(c);if(a instanceof J&&(!c||a._uri===c)&&(!b||a.getSchema().equals(b))){return a}return new J(this,a,c,b)};P.prototype.createEmptySchema=function(){return this._schemas["urn:jsv:empty-schema#"]};P.prototype.findSchema=function(a){return this._schemas[ab(a)]};P.prototype.setOption=function(b,a){this._options[b]=a};P.prototype.getOption=function(a){return this._options[a]};P.prototype.setDefaultFragmentDelimiter=function(a){if(typeof a==="string"&&a.length>0){this._options.defaultFragmentDelimiter=a}};P.prototype.getDefaultFragmentDelimiter=function(){return this._options.defaultFragmentDelimiter};P.prototype.setDefaultSchemaURI=function(a){if(typeof a==="string"){this._options.defaultSchemaURI=ab(a)}};P.prototype.getDefaultSchema=function(){return this.findSchema(this._options.defaultSchemaURI)};P.prototype.validate=function(a,b){var h,e,f,g=new K();try{h=this.createInstance(a);g.instance=h}catch(c){g.addError(c.uri,c.schemaUri,c.attribute,c.message,c.details)}try{e=this.createSchema(b);g.schema=e;f=e.getSchema();g.schemaSchema=f}catch(d){g.addError(d.uri,d.schemaUri,d.attribute,d.message,d.details)}if(f){f.validate(e,g)}if(g.errors.length){return g}return e.validate(h,g)};P.prototype._checkForInvalidInstances=function(g,a){var d=[],i=[[a,this._schemas[a]]],c=0,e,b,f,j,h;while(c++<g&&i.length){e=i.shift();b=e[0];f=e[1];if(f instanceof J){if(this._schemas[f._uri]!==f){d.push("Instance "+b+" does not match "+f._uri)}else{j=f.getAttributes();for(h in j){if(j[h]!==X[h]){i.push([b+"/"+D(h),j[h]])}}}}else{if(Y(f)==="object"){j=f;for(h in j){if(j.hasOwnProperty(h)){i.push([b+"/"+D(h),j[h]])}}}else{if(Y(f)==="array"){j=f;for(h=0;h<j.length;++h){i.push([b+"/"+D(h),j[h]])}}}}}return d.length?d:c};V={_environments:{},_defaultEnvironmentID:"",isJSONInstance:function(a){return a instanceof E},isJSONSchema:function(a){return a instanceof J},createEnvironment:function(a){a=a||this._defaultEnvironmentID;if(!this._environments[a]){throw new Error("Unknown Environment ID")}return this._environments[a].clone()},Environment:P,registerEnvironment:function(a,b){a=a||(b||0)._id;if(a&&!this._environments[a]&&b instanceof P){b._id=a;this._environments[a]=b}},setDefaultEnvironmentID:function(a){if(typeof a==="string"){if(!this._environments[a]){throw new Error("Unknown Environment ID")}this._defaultEnvironmentID=a}},getDefaultEnvironmentID:function(){return this._defaultEnvironmentID},typeOf:Y,createObject:H,mapObject:aa,mapArray:R,filterArray:N,searchArray:B,toArray:F,keys:O,pushUnique:W,popFirst:M,clone:C,randomUUID:G,escapeURIComponent:D,formatURI:ab,inherits:S,InitializationError:Z};this.JSV=V;exports.JSV=V;require("./environments")}());